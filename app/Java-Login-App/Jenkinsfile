pipeline {
    agent any

    tools {
        jdk 'JDK_17'
        maven 'MAVEN3.8.7'
        'dependency-check' 'Owas-dependency-check-10'
    }

    environment {
        APP_NAME    = "dptweb"
        APP_VERSION = "1.0"
        TOMCAT_HOME = "/opt/tomcat"
        WAR_NAME    = "${APP_NAME}-${APP_VERSION}.war"
        APP_DIR     = "app/Java-Login-App"
    }

    stages {

        stage('Change Detection') {
            steps {
                echo "✅ Source code detected, starting pipeline"
            }
        }

        stage('Validate') {
            steps {
                sh '''
                    cd ${APP_DIR}
                    mvn clean
                    mvn validate
                    
                '''
            }
        }

        stage('Comlile') {
            steps {
                sh '''
                    cd ${APP_DIR}
                    mvn clean compile -DskipTests
                    
                '''
            }
        }


        stage('Dependency scanning') {
            parallel {
                /* =========================================
                 * 1. CLI OWASP Dependency-Check + Manual Gate
                 * ========================================= */
                 
                 stage('CLI Dependency Audit') {
                    steps {
                        sh """
                            cd ${APP_DIR}

                            mvn org.owasp:dependency-check-maven:check \
                                -DautoUpdate=false \
                                -Dformat=XML
                        """
                        
                        sh """
                            cd ${APP_DIR}

                            CRITICAL=\$(grep -o '<severity>Critical</severity>' target/dependency-check-report.xml | wc -l)
                            HIGH=\$(grep -o '<severity>High</severity>' target/dependency-check-report.xml | wc -l)

                            echo "Critical vulnerabilities: \$CRITICAL"
                            echo "High vulnerabilities: \$HIGH"

                            TOTAL=\$((CRITICAL + HIGH))

                            if [ "\$TOTAL" -gt 1 ]; then
                              echo "❌ More than 1 High/Critical vulnerability found"
                              exit 1
                            else
                              echo "✅ Vulnerability threshold acceptable"
                            fi
                        """
                    }
                 }
                 
                 stage('Jenkins OWASP Plugin Scan') {
                    steps {
                        dependencyCheck additionalArguments: '''
                            -n
                            --scan ${APP_DIR}
                            --out ${APP_DIR}/target/odc-jenkins
                            --format XML
                            --prettyPrint
                        ''',
                        odcInstallation: 'Owas-dependency-check-10'
                        dependencyCheckPublisher(
                            pattern: '${APP_DIR}/target/odc-jenkins/dependency-check-report.xml',
                            failedTotalCritical: 1,
                            stopBuild: true
                        )
                    }
                 }
            }
        }
    }
}
                 